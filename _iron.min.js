var templayed=require("templayed"),compressor=require("node-minify"),msgpack=require("msgpack-js"),rimraf=require("rimraf"),async=require("async"),path=require("path"),http=require("http"),fs=require("fs"),bus=require("./_bus.js"),redis=require("redis"),client=redis.createClient();
var Iron=function(){var a=this;a.readJson=function(b){fs.readdir("./",function(d,c){async.forEach(c,function(f,e){var g=f.split(".")[1];if(g=="json"&&f!="package.json"){fs.readFile(f,function(k,h){var i=f.replace("_","").replace(".json",""),j=h.toString();
a[i]=JSON.parse(j);e();});}else{e();}},function(){b();});});};a.setup=function(e){var d=false,c=false,b=false;fs.readFile(a.info.config_ui,function(k,h){var j=h.toString();
a.ui=JSON.parse(j);l(function(){g();});i(function(){g();});function g(){if(b==true&&d==true){e();}}function i(m){fs.readFile(a.info.config_frame,function(r,o){var n=JSON.stringify(a.user.default_modules);
var q=o.toString(),p=templayed(q)({default_modules:n});client.set("master_template",p,redis.print);d=true;m();});}function f(m){fs.readFile(a.ui.local_css,function(o,n){fs.unlink(a.ui.public_css,function(){fs.writeFile(a.ui.public_css,n,function(p){c=true;
m();});});});}function l(m){fs.readFile(a.info.config_modules,function(p,n){var o=n.toString(),q="";a.modules=JSON.parse(o);async.forEach(a.modules.client,function(s,r){fs.readFile("./mods/"+s.file,function(u,t){q+="\n"+t.toString();
r();});},function(){fs.readFile(a.ui.js,function(s,r){q+=r.toString();fs.readFile(a.ui.templates,function(u,t){q+='\n ui.markup = "'+t.toString()+'";\n ui.templates = document.createElement("div");\n ui.templates.innerHTML = ui.markup;';
fs.unlink(a.info.compiled_modules,function(){fs.writeFile(a.info.compiled_modules,q,function(){new compressor.minify({type:"uglifyjs",fileIn:a.info.compiled_modules,fileOut:a.info.compiled_modules.replace(".js",".min.js"),callback:function(v){console.log(v);
b=true;m();}});});});});});});});}});};a.req=function(c,b){client.get("master_template",function(e,d){b.end(d.toString());});};a.interpret=function(c,g){var l=c[0],j=c[1],f=c[2].split(" "),k=[],i=true;
for(command in a.info.commands){if(command==f[0]){i=false;var h=a.info.commands[command].split("|"),d=h[0],b=h[1],e=f[1];global[d][b](e,function(m){k=m;
g(k);});break;}}if(i==true){g(["skeleton","log","command not found"]);}};a.getData=function(c,b){client.hmget(a.user.name,c,function(d,e){b(e);});};a.setData=function(c,b){client.hmset(a.user.name,c[0],c[1],function(){});
};a.createUser=function(c,b){client.hset(c,"default_modules",a.user.default_modules,function(){b(["skeleton","log","created user: "+c]);});};a.recHistory=function(c){var b=JSON.stringify(c);
bus.sendGlobal(c);a.setData(["env",b]);};a.playHistory=function(c,b){a.getData(["env"],function(e){var d=JSON.parse(e);b(d);});};};global.iron=new Iron();
exports=module.exports=iron;
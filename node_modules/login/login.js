var through = require('through')

module.exports = function (C) {
  var loginForm

  var user = (window.location.host.split('.').length ===  3)
    ? window.location.host.split('.')[0]
    : 'default'

  var s = through(function Write (d) { 
    if (d.token && d.token === sessionStorage[user]) C.erase(erase)
    if (d instanceof Error) 
      loginForm.querySelector('input').style.background = 'red'
  })

  C.bind = function (ele) {
    loginForm = ele.querySelector('#loginForm')
    loginForm.addEventListener('submit', sendLogin, false)
  }

  C.unbind = function () {
    loginForm.removeEventListener('submit', sendLogin)
  }

  C.draw()

  function sendLogin (e) {
    e.preventDefault()
    s.emit('data', {
      key : 'auth',
      value : {
        origin: C.html.id,
        name: user,
        pass : e.target[0].value
      }
    })
  }

  return s
}

var through = require('through2') // fix this thing up!

module.exports = function Actions (C) {
  var omnibox
  var menu
  var search

  var s = through.obj(function Write (chunk, enc, next) { 
    console.log(chunk)
    next()
  })

  if (localStorage.library && localStorage.library.length > 0) {
    var library = JSON.parse(localStorage.library)
  } else library = null // request library

  window.addEventListener('contextmenu', ctx, false)

  function ctx (e) {
    e.preventDefault()
    var element = e.target
    var id = element.id
    var parent = element.parentElement // ?
    var cl = element.className
    var tag = element.tagName
    console.log(element, parent, parent.id, tag, cl)
  }
 
  window.addEventListener('keydown', function toggleOmni (e) {
    if (e.keyCode === 38) { omni.live = false; search.focus() }
    if (e.keyCode === 37) omni.prev()
    if (e.keyCode === 39) omni.next()
    if (C.live && omni.live === true && e.keyCode === 13) omni.go()
    if (e.keyCode === 9) {  // keybindings!
      e.preventDefault();
      (C.live === false) ? C.draw() : C.erase()
      return false
    }
  }, false) 

  function updateSearch (e) { // search materials --> send res to omni
    e.preventDefault()
    omnibox.innerHTML = ''
    var str = search.value
    var res = find(library, str) 

    if (res) // preview res
      omnibox.innerHTML = res.name

    if (e.keyCode === 40 || e.keyCode === 39 || e.keyCode === 13) {
      console.log(e.keyCode)
      e.preventDefault()
      search.blur()
      if (res) omni._ = res
      omni.live = true
    }
  }

  function processResult (d) {
    if (typeof d === 'object') {
      if (d.nimoy) {
        console.log('its a package!')
      }
    }
  }

  var omni = {
    _ : null,
    live : false,
    next : function () { // modify cmds
      console.log('next!')
    },
    prev : function () {
      console.log('prev!')
    },
    go : function () {
      if (typeof this._ === 'object' && this._.nimoy) {
        var pkg = this._
        s.push({key:'draw', value: pkg})
      }
    }
  }
    
  function fileUpload (e) {
    e.preventDefault()
    var files = e.dataTransfer.files
    for (file in files) {
      if (file === 'length') return

      var fileName = files[file].name

      var formData = new FormData()
      formData.append('file', fileName)
      formData.append('token', 'test123') // !?

      var xhr = new XMLHttpRequest()
      xhr.open('post', '/upload', true) 
      xhr.addEventListener('error', function (e) { console.error(e) }, false) 
      xhr.addEventListener('progress', function (e) { 
        console.log(e)
      }, false) 

      var reader = new FileReader()
      reader.readAsDataURL(files[file])
      reader.addEventListener('load', function (data) {
        console.log(data)
        formData.append('blob', data.target.result)
        console.log(formData)
        xhr.send(formData)
      }, false)
    }
  }
    
  function cancel (e) {
    e.preventDefault()
    if (e.stopPropogation) e.stopPropogation()
    return false
  }
    
  // logic for processing omni results
  C.unbind = function () {
    search.removeEventListener('keyup', updateSearch)
    omnibox.removeEventListener('drop', fileUpload)
    omnibox.removeEventListener('dragover', cancel)
    omnibox.removeEventListener('dragenter', cancel)
    omnibox.removeEventListener('dragleave', cancel)
  }

  C.bind = function (domNode) {
    omnibox = domNode.querySelector('.omnibox')
    omnibox.addEventListener('dragleave', cancel, false)
    omnibox.addEventListener('dragenter', cancel, false)
    omnibox.addEventListener('dragover', cancel, false)
    omnibox.addEventListener('drop', fileUpload, false)
    search = domNode.querySelector('#search')
    search.addEventListener('keyup', updateSearch, false)
    search.focus()
  }

  return s
}

function find (haystack, needle) {
  for (hay in haystack) {
    if (needle !== '' && hay.match(needle)) return haystack[hay]
  }
}

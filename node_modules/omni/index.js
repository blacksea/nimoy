var asyncMap = require('slide').asyncMap
var through = require('through2')
var D = require('browser/mini')
var utils = require('utils')
var cancel = utils.cancel


module.exports = function Omni (id, template) { // >>>>>>>>>>>>>>>>>>>>>>>>>>>>
  var live

  var library = (!localStorage.library) 
    ? null
    : JSON.parse(localStorage.library)

  var s = through.obj(function Write (d, enc, next) { 
    if (d.to && d.to === id) {
      if (d.key === 'canvas:library') {
        library.canvas = JSON.parse(d.value)
      } else grifter.data(d.value)
    }
    next()
  })

  // key interactions >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  function keyMappings (e) {
    if (e.keyCode === 27) { e.preventDefault(); om.toggle() }
    if (e.keyCode === 40 || e.keyCode === 38 && live) {
      e.preventDefault() 
      var incdec = (e.keyCode ===38) ? 'inc' : 'dec'
      om.sel(incdec) 
    }
  } // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  var grifter = { // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    tools : {},
    target : null,
    moduleID : null,
    property : null,
    data : function (d) {
      var data = JSON.parse(d)
      var branch = grifter.property
      grifter.tools[grifter.type](function (val) {
        if (branch.length===1) data[branch[0]] = val
        if (branch.length===2) data[branch[0]][branch[1]] = val
        if (branch.length===3) data[branch[0]][(branch[1]-1)][branch[2]] = val
        var res = JSON.stringify(data)
        s.push({key:'data', value: {key:'module:'+grifter.moduleID, data:res}})
      })
    },
    parse : function (e) {
      if (live === false) return false
      e.preventDefault()
      var t = e.target
      if (t.className.match('grifter')) {t.style.display='none'; return false}
      if (!t.className.match(':') && !grifter.tools[t.className.split(':')[0]])
        return false

      var prop =  (t.className.match(' ')) 
        ? t.className.split(' ')[0].split(':')
        : t.className.split(':')

      grifter.target = t
      grifter.type = prop[0]
      grifter.property = prop.slice(1)
      grifter.moduleID = utils.climb(t)
      s.push({from:id, key:'get', value:'module:'+grifter.moduleID})
    }
  }
  grifter.tools.img = function (cb) {
    dropzone({
      x : grifter.target.getBoundingClientRect().left + 'px',
      y : grifter.target.getBoundingClientRect().top + 'px',
      h : grifter.target.offsetHeight + 'px',
      w : grifter.target.offsetWidth + 'px'
    }, function (el) {
      el.style.display = 'block'
      el.addEventListener('dragover', cancel, false)
      el.addEventListener('dragenter', cancel, false)
      el.addEventListener('dragleave', cancel, false)
      el.addEventListener('drop', function (e) {
        fileUpload(e, function (d) {
          grifter.target.style.backgroundImage = 'url('+d.data+')'
          grifter.target.style.backgroundScale = 'auto'
          cb('/files/'+d.file)
        })
      })
    })
  }
  grifter.tools.txt = function (cb) {
    edit({
      x : grifter.target.getBoundingClientRect().left + 'px',
      y : grifter.target.getBoundingClientRect().top + 'px',
      h : grifter.target.offsetHeight + 'px',
      w : grifter.target.offsetWidth + 'px'
    }, function (el) {
      el.value = grifter.target.innerHTML.replace(/<br\s?\/?>/g,"\n")
      el.addEventListener('keyup', function (ev) {
        var html = el.value.replace(/\r\n|\r|\n/g,"<br />")
        grifter.target.innerHTML = html
      }, false)
      el.addEventListener('keydown', function (ev) {
        if (ev.shiftKey === true && ev.keyCode === 13) {
          ev.preventDefault()
          el.style.display = 'none'
          var html = el.value.replace(/\r\n|\r|\n/g,"<br />")
          cb(html)
        }
      }, false)
      el.focus()
    })
  } // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  var om = { // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    value : null,
    selCmd : 0,
    commands : [ 
      {txt:'new', cmd:'put'},
      {txt:'open', cmd:'canvas:open'},
      {txt:'save', cmd:'canvas:save'}
    ],
    input : function (e) {
      e.preventDefault()
      var str = e.target.value
      var selCmd = om.commands[om.selCmd].cmd 

      if (selCmd === 'put' || selCmd === 'canvas:open') { 
        var lib = (selCmd === 'put') ? library.global : library.canvas
        var res =  utils.search(lib, str).name
        if (res && str !== '') {
          om.value = res
          notify({msg : res})
        } else {
          om.value = null
          notify({msg : ''})
        }
      } else om.value = str

      if (e.keyCode === 13 && str !== '') om.exec()
    },
    exec : function () {
      var command = om.commands[om.selCmd].cmd
      if (command === 'canvas:open') {
        window.location.hash = om.value
        return false
      }
      s.push({
        key : command,
        value : om.value
      })
    },
    toggle : function () {
      if (live === true) {
        live = false
        omni.style.display = 'none'
        document.querySelector('.hilite').style.display = 'none'
      } else if (live === false) {
        live = true
        omni.style.display = 'block'
        document.body.querySelector('#search').focus()
      }
    },
    sel : function (incdec) {
      var val = utils.incdec(incdec, om.selCmd, 0, om.commands.length-1)
      om.selCmd = val
      if (om.commands[om.selCmd].cmd === 'canvas:open') { 
        s.push({key:'canvas:library',from:id})
      }
      cmd(om.commands[om.selCmd])
    }
  } // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  // dom >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  var dropzone
  var notify
  var omni
  var edit
  var cmd
  var  hilite = D(document.body, template.get('.hilite'))
  var tmpl = template.get('.omni')

  D(document.body, tmpl, utils.cuid()).draw(om.commands, function (el) {
    omni = el
    live = true
    cmd = D(el.querySelector('.command'), template.get('.cmd')).draw
    edit = D(omni, template.get('.editBox')).draw
    dropzone = D(omni, template.get('.dropzone')).draw
    notify = D(el.querySelector('.messages'), 
               template.get('.notification')).draw
    cmd(om.commands[om.selCmd])
    el.querySelector('#search').addEventListener('keyup', om.input, false)
    el.querySelector('#search').focus()
    var s = 0
    document.querySelector('.command').addEventListener('mousewheel', function (e) {
      if (e.wheelDeltaY > 0) { s++ } else s--
    }, false)
  }) // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  function fileUpload (e, cb) {
    e.preventDefault()
    var files = []
    var droppedFiles = e.dataTransfer.files

    for (var i=0; i<droppedFiles.length; i++) {
      var f = droppedFiles[i]
      if (f.type.match('image.*')) files.push(f)
    }

    asyncMap(files, function handleFile (file, next) {
      var fileName = file.name
      var cleanName = file.name.replace(/ /g,'_')
      var fileID = utils.cuid()

      var formData = new FormData()
      formData.append('file', cleanName)

      var xhr = new XMLHttpRequest()
      xhr.upload.addEventListener('progress', function (e) { 
        var percent = (e.loaded / e.total) * 100
        notify({msg: 'uploading ' + cleanName + percent+' %'})
        if (e.loaded === e.total) setTimeout(function () {
          notify({msg:''})
        }, 400)
      }, false) 
      xhr.open('post', '/upload', true) 

      var reader = new FileReader()

      reader.addEventListener('load', function (data) {
        formData.append('id', fileID)
        formData.append('blob', data.target.result)
        xhr.send(formData)
        cb({file:cleanName, data:data.target.result})
        next()
      }, false)

      reader.readAsDataURL(file)
    }, function End () { console.dir(droppedFiles) })
  } // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

  window.addEventListener('contextmenu', grifter.parse, false)
  window.addEventListener('keydown', keyMappings, false)
  window.addEventListener('mousemove', function (e) {
    if (!live) return false
    var t = e.target
    var hi
    if (t.className.match(':') && grifter.tools[t.className.split(':')[0]]) {
      hilite.draw({
        x : (e.target.getBoundingClientRect().left-4) + 'px',
        y : (e.target.getBoundingClientRect().top-4) + 'px',
        h : (e.target.offsetHeight) + 'px',
        w : (e.target.offsetWidth) + 'px'
      })
    } else if (t.className !== 'hilite') { 
      if (document.querySelector('.hilite'))
        document.querySelector('.hilite').style.display = 'none'
    }
  }, false)

  return s
}
